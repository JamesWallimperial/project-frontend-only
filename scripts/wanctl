#!/usr/bin/env bash
# Block/unblock WAN access for hotspot clients by MAC
# Usage:
#   sudo wanctl block <MAC>
#   sudo wanctl unblock <MAC>
#   sudo wanctl list

WAN_IF="eth0"   # outbound/WAN interface, adjust if needed

set -euo pipefail

cmd="${1:-}"
mac="${2:-}"

case "$cmd" in
  block)
    [[ -z "$mac" ]] && { echo "Usage: $0 block <MAC>"; exit 1; }
    sudo iptables -I FORWARD -o "$WAN_IF" -m mac --mac-source "$mac" -j DROP
    echo "Blocked WAN access for $mac"
    ;;
  unblock)
    [[ -z "$mac" ]] && { echo "Usage: $0 unblock <MAC>"; exit 1; }
    # Delete all matching rules for this MAC
    while sudo iptables -D FORWARD -o "$WAN_IF" -m mac --mac-source "$mac" -j DROP 2>/dev/null; do :; done
    echo "Unblocked WAN access for $mac"
    ;;
  list)
    echo "Currently blocked MACs:"
    sudo iptables -S FORWARD | grep "DROP" | grep -- "--mac-source" || echo "  (none)"
    ;;
  *)
    echo "Usage: $0 {block <MAC>|unblock <MAC>|list}"
    exit 1
    ;;
esac
